# Configuración de Laravel Cloud
# Este archivo define cómo Laravel Cloud debe construir y desplegar la aplicación

version: 1

build:
  # Comando de construcción optimizado
  command: |
    # Copiar archivo de entorno
    cp laravel-cloud.env .env
    
    # Instalar dependencias
    npm install
    composer install --no-dev --optimize-autoloader --no-scripts
    
    # Compilar assets
    npm run build
    
    # Crear directorios necesarios
    mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache
    
    # Generar clave de aplicación
    php artisan key:generate --force
    
    # Optimizar para producción
    php artisan config:cache
    php artisan route:cache
    php artisan view:cache
  timeout: 600
  
  # Variables de entorno durante el build
  environment:
    APP_ENV: production
    CACHE_DRIVER: redis
    SESSION_DRIVER: database
    QUEUE_CONNECTION: redis

deploy:
  # Comando de despliegue optimizado
  command: |
    # Verificar que .env existe
    if [ ! -f ".env" ]; then
      echo "Error: .env file not found"
      exit 1
    fi
    
    # Configurar Redis para producción
    sed -i 's/CACHE_DRIVER=.*/CACHE_DRIVER=redis/' .env
    sed -i 's/QUEUE_CONNECTION=.*/QUEUE_CONNECTION=redis/' .env
    sed -i 's/SESSION_DRIVER=.*/SESSION_DRIVER=database/' .env
    
    # Recargar configuración
    php artisan config:cache
  timeout: 300

runtime:
  # Versión de PHP
  php: 8.2
  
  # Versión de Node.js
  node: 18
  
  # Extensiones de PHP requeridas
  extensions:
    - redis
    - pdo_mysql
    - mbstring
    - openssl
    - tokenizer
    - xml
    - ctype
    - json
    - bcmath

optimizations:
  # Optimizaciones automáticas
  cache_config: true
  cache_routes: true
  cache_views: true
  optimize_autoloader: true
  
  # Optimizaciones adicionales
  cache_events: true
  cache_packages: true
  preload: true
  opcache: true
  
  # Compresión
  gzip: true
  
  # Minificación
  minify_assets: true
