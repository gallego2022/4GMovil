# Configuración de Laravel Cloud - DESARROLLO
# Este archivo define cómo Laravel Cloud debe construir y desplegar la aplicación en entorno de desarrollo

version: 1

build:
  # Comando de construcción optimizado
  command: |
    cp laravel-cloud.env .env
    npm ci --timeout=300000
    composer install --no-dev --optimize-autoloader --no-scripts
    npm run build
    mkdir -p storage/framework/{cache,sessions,views} storage/logs bootstrap/cache storage/app/public/{productos,fotos_perfil,perfiles}
    chmod -R 755 storage
    chmod -R 777 storage/framework storage/logs storage/app/public
    chmod -R 777 bootstrap/cache
    php artisan key:generate --force
    php artisan config:cache
    php artisan route:cache
    php artisan view:cache
    php artisan package:discover --ansi
    php artisan storage:link
    chmod -R 755 public/storage
  timeout: 900
  
  # Variables de entorno durante el build (DESARROLLO)
  environment:
    APP_ENV: local
    APP_DEBUG: true
    CACHE_DRIVER: redis
    SESSION_DRIVER: database
    QUEUE_CONNECTION: redis

deploy:
  # Comando de despliegue optimizado
  command: |
    sed -i 's/CACHE_DRIVER=.*/CACHE_DRIVER=redis/' .env
    sed -i 's/QUEUE_CONNECTION=.*/QUEUE_CONNECTION=redis/' .env
    sed -i 's/SESSION_DRIVER=.*/SESSION_DRIVER=database/' .env
    chmod -R 755 storage
    chmod -R 777 storage/framework storage/logs storage/app/public
    chmod -R 777 bootstrap/cache
    php artisan config:cache
    php artisan migrate --force
  timeout: 300

runtime:
  # Versión de PHP
  php: 8.3
  
  # Versión de Node.js
  node: 18
  
  # Extensiones de PHP requeridas
  extensions:
    - redis
    - pdo_mysql
    - mbstring
    - openssl
    - tokenizer
    - xml
    - ctype
    - json
    - bcmath
    - gd
    - zip
    - exif
    - pcntl

optimizations:
  # Optimizaciones automáticas
  cache_config: true
  cache_routes: true
  cache_views: true
  optimize_autoloader: true
  
  # Optimizaciones adicionales
  cache_events: true
  cache_packages: true
  preload: true
  opcache: true
  
  # Compresión
  gzip: true
  
  # Minificación
  minify_assets: true
